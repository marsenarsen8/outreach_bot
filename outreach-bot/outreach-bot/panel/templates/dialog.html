{% extends "base.html" %}

{% block title %}–î–∏–∞–ª–æ–≥ —Å {{ user_id }} - Outreach Bot Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üí¨ –î–∏–∞–ª–æ–≥ —Å {{ user_id }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/contacts" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º
            </a>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>
</div>

{% if error %}
<div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞: {{ error }}
</div>
{% endif %}

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</strong> {{ user_id }}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å –¥–∏–∞–ª–æ–≥–∞:</strong> 
                    {% if dialog_history %}
                        {% set last_message = dialog_history[-1] %}
                        {% if last_message.type == 'bot' %}
                            <span class="badge bg-primary">–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞</span>
                        {% else %}
                            <span class="badge bg-success">–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-6">
                <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:</strong> {{ dialog_history|length }}</p>
                <p><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> 
                    {% if dialog_history %}
                        {{ dialog_history[-1].timestamp }}
                    {% else %}
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ -->
<div class="card shadow">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞</h6>
    </div>
    <div class="card-body">
        {% if dialog_history %}
            <div class="chat-container" style="max-height: 600px; overflow-y: auto;">
                {% for message in dialog_history %}
                <div class="message-container mb-3">
                    <div class="d-flex {% if message.type == 'bot' %}justify-content-start{% else %}justify-content-end{% endif %}">
                        <div class="message {% if message.type == 'bot' %}bot-message{% else %}client-message{% endif %}" 
                             style="max-width: 70%; padding: 10px 15px; border-radius: 15px; margin: 5px;">
                            {% if message.type == 'bot' %}
                                <div class="bot-message" style="background-color: #e3f2fd; border-left: 4px solid #2196f3;">
                                    <div class="message-header">
                                        <small class="text-muted">
                                            <i class="fas fa-robot"></i> –ë–æ—Ç ‚Ä¢ {{ message.timestamp }}
                                        </small>
                                    </div>
                                    <div class="message-content mt-2">
                                        {{ message.text }}
                                    </div>
                                    {% if message.reply %}
                                    <div class="message-reply mt-2" style="background-color: #f5f5f5; padding: 8px; border-radius: 8px; font-size: 0.9em;">
                                        <strong>–û—Ç–≤–µ—Ç –±–æ—Ç–∞:</strong> {{ message.reply }}
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="client-message" style="background-color: #f1f8e9; border-left: 4px solid #4caf50;">
                                    <div class="message-header">
                                        <small class="text-muted">
                                            <i class="fas fa-user"></i> –ö–ª–∏–µ–Ω—Ç ‚Ä¢ {{ message.timestamp }}
                                        </small>
                                    </div>
                                    <div class="message-content mt-2">
                                        {{ message.text }}
                                    </div>
                                    {% if message.analysis %}
                                    <div class="message-analysis mt-2" style="background-color: #fff3e0; padding: 8px; border-radius: 8px; font-size: 0.9em;">
                                        <strong>–ê–Ω–∞–ª–∏–∑:</strong> 
                                        {% if message.analysis == '–î–ê' %}
                                            <span class="badge bg-success">–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω</span>
                                        {% elif message.analysis == '–ù–ï–¢' %}
                                            <span class="badge bg-warning">–ù–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ message.analysis }}</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- –î–µ–π—Å—Ç–≤–∏—è -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">–î–µ–π—Å—Ç–≤–∏—è</h6>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    {% if dialog_history and dialog_history[-1].type == 'client' and dialog_history[-1].analysis == '–ù–ï–¢' %}
                    <button type="button" class="btn btn-warning" onclick="reprocessDialog()">
                        <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-info" onclick="exportDialog()">
                        <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∏–∞–ª–æ–≥–∞
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="printDialog()">
                        <i class="fas fa-print"></i> –ü–µ—á–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function reprocessDialog() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ—Ç –¥–∏–∞–ª–æ–≥?')) {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
        alert('–§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ');
    }
}

function exportDialog() {
    // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    let exportText = `–î–∏–∞–ª–æ–≥ —Å ${user_id}\n`;
    exportText += `–î–∞—Ç–∞: ${new Date().toLocaleString()}\n\n`;
    
    {% for message in dialog_history %}
    exportText += `[${message.timestamp}] ${message.type === 'bot' ? '–ë–æ—Ç' : '–ö–ª–∏–µ–Ω—Ç'}: ${message.text}\n`;
    {% endfor %}
    
    // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const blob = new Blob([exportText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dialog_${user_id}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function printDialog() {
    window.print();
}

// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>

<style>
@media print {
    .sidebar, .btn-toolbar, .card-header, .btn-group {
        display: none !important;
    }
    .main-content {
        margin-left: 0 !important;
    }
    .card {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
    }
}

.bot-message {
    background-color: #e3f2fd !important;
    border-left: 4px solid #2196f3 !important;
}

.client-message {
    background-color: #f1f8e9 !important;
    border-left: 4px solid #4caf50 !important;
}

.message-container {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %} 